<% layout('layout') %>

<h2>Carrito de compras</h2>

<% if (cart.totalQty === 0) { %>
  <p>Tu carrito está vacío.</p>
<% } else { %>
  <table class="cart-table">
    <thead>
      <tr>
        <th>Producto</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Subtotal</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <% Object.values(cart.items).forEach(item => { %>
        <tr>
          <td><%= item.nombre %></td>
          <td>$<%= item.precio.toFixed(2) %></td>
          <td>
            <form class="update-form" action="/cart/update/<%= item.productId %>" method="POST">
              <input type="number" name="quantity" value="<%= item.quantity %>" min="1" 
                data-product-id="<%= item.productId %>" class="cart-qty-input">
            </form>
          </td>
          <td>$<%= (item.precio * item.quantity).toFixed(2) %></td>
          <td>
            <form action="/cart/remove/<%= item.productId %>" method="POST">
              <button type="submit">Eliminar</button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <div class="cart-summary">
    <p>Total de artículos: <span id="cartTotalQty"><%= cart.totalQty %></span></p>
    <p>Total a pagar: $<span id="cartTotalPrice"><%= cart.totalPrice.toFixed(2) %></span></p>

    <% if (!currentUser) { %>
      <p class="alert warning">Debes iniciar sesión para realizar la compra.</p>
      <a href="/login" class="btn-primary">Iniciar sesión</a>
    <% } else { %>
      <form action="/cart/checkout" method="POST">
        <button type="submit" class="btn-primary">Finalizar compra</button>
      </form>
    <% } %>
  </div>
<% } %>
